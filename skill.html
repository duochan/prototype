<!DOCTYPE html>
<html lang="zh-CN" class="">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>探域科技 - 工具管理集</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet"/>
    
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet"/>
    
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#1677ff", // Brand Blue
                        "primary-hover": "#4096ff",
                        "background-light": "#f5f5f5",
                        "background-dark": "#121212",
                        "surface-light": "#ffffff",
                        "surface-dark": "#1e1e1e",
                        "border-light": "#e5e7eb",
                        "border-dark": "#333333",
                        "text-primary-light": "#1f1f1f",
                        "text-primary-dark": "#e5e5e5",
                        "text-secondary-light": "#6b7280",
                        "text-secondary-dark": "#9ca3af",
                    },
                    fontFamily: {
                        sans: ['"Inter"', '"Noto Sans SC"', 'sans-serif'],
                    },
                    boxShadow: {
                        'modal': '0 4px 12px rgba(0, 0, 0, 0.15)',
                        'card-hover': '0 4px 10px rgba(0, 0, 0, 0.1)',
                        'dropdown': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                    }
                },
            },
        };
    </script>
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #4b5563;
        }
        
        /* Modal Animation */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-fade-in-up {
            animation: fadeInUp 0.3s ease-out forwards;
        }

        /* Smooth transition for drawer */
        .drawer-transition {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #ffffff;
            width: 24px;
            height: 24px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        
        .spinner-blue {
            border: 3px solid rgba(22, 119, 255, 0.1);
            border-top: 3px solid #1677ff;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-text-primary-light dark:text-text-primary-dark font-sans transition-colors duration-200 antialiased h-screen overflow-hidden flex">

    <!-- Sidebar -->
    <aside class="w-64 bg-surface-light dark:bg-surface-dark border-r border-border-light dark:border-border-dark flex-shrink-0 flex flex-col h-full overflow-y-auto z-10">
        <!-- Logo Area -->
        <div class="h-16 flex items-center px-4 border-b border-border-light dark:border-border-dark sticky top-0 bg-surface-light dark:bg-surface-dark z-20">
            <div class="flex items-center space-x-2 text-primary font-bold text-xl cursor-pointer" onclick="toggleDarkMode()" title="点击切换深色模式">
                <span class="material-icons-outlined">science</span>
                <span>探域科技</span>
            </div>
            <div class="ml-auto bg-blue-50 dark:bg-blue-900/30 text-primary text-xs px-2 py-0.5 rounded flex items-center gap-1 cursor-pointer hover:bg-blue-100 dark:hover:bg-blue-900/50 transition-colors">
                <span class="material-icons-outlined text-sm">cloud</span>
                <span>智能体</span>
                <span class="material-icons-outlined text-sm rotate-180">logout</span>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 py-4 space-y-1">
            <a class="flex items-center px-4 py-2 text-text-secondary-light dark:text-text-secondary-dark hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors group" href="#">
                <span class="material-icons-outlined mr-3 text-lg">home</span>
                <span class="text-sm">首页</span>
            </a>

            <!-- Dropdown Menu Item (Expanded) -->
            <div>
                <button class="w-full flex items-center justify-between px-4 py-2 text-primary bg-blue-50 dark:bg-blue-900/20 dark:text-primary transition-colors">
                    <div class="flex items-center">
                        <span class="material-icons-outlined mr-3 text-lg">support_agent</span>
                        <span class="text-sm font-medium">客服Agent</span>
                    </div>
                    <span class="material-icons-outlined text-sm">expand_more</span>
                </button>
                <div class="pl-12 py-1 space-y-1">
                    <a class="block py-2 text-sm text-text-secondary-light dark:text-text-secondary-dark hover:text-primary transition-colors" href="#">基础配置</a>
                    <a class="block py-2 text-sm text-text-secondary-light dark:text-text-secondary-dark hover:text-primary transition-colors" href="#">记忆库</a>
                    <a class="block py-2 text-sm text-text-secondary-light dark:text-text-secondary-dark hover:text-primary transition-colors" href="customize_agent.html">自定义Agent</a>
                    <!-- Active Sub-item -->
                    <a class="block py-2 text-sm text-primary font-medium bg-blue-50 dark:bg-blue-900/20 rounded-l-md -mr-4 pl-4 border-r-2 border-primary relative" href="#">
                        工具集
                    </a>
                </div>
            </div>

            <a class="flex items-center px-4 py-2 text-text-secondary-light dark:text-text-secondary-dark hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" href="#">
                <span class="material-icons-outlined mr-3 text-lg">menu_book</span>
                <span class="text-sm">知识中心</span>
                <span class="material-icons-outlined ml-auto text-sm text-gray-400">chevron_right</span>
            </a>
            <a class="flex items-center px-4 py-2 text-text-secondary-light dark:text-text-secondary-dark hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" href="#">
                <span class="material-icons-outlined mr-3 text-lg">analytics</span>
                <span class="text-sm">诊断优化</span>
                <span class="material-icons-outlined ml-auto text-sm text-gray-400">chevron_right</span>
            </a>
            <a class="flex items-center px-4 py-2 text-text-secondary-light dark:text-text-secondary-dark hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" href="#">
                <span class="material-icons-outlined mr-3 text-lg">people</span>
                <span class="text-sm">子帐号列表</span>
            </a>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col min-w-0 bg-background-light dark:bg-background-dark overflow-hidden relative">
        
        <!-- Top Header -->
        <header class="h-16 bg-surface-light dark:bg-surface-dark border-b border-border-light dark:border-border-dark flex items-center justify-between px-6 z-20 flex-shrink-0">
            <!-- Breadcrumbs -->
            <div class="flex items-center text-text-secondary-light dark:text-text-secondary-dark text-sm">
                <span>客服Agent</span>
                <span class="material-icons-outlined text-sm mx-2">chevron_right</span>
                <span class="text-text-primary-light dark:text-text-primary-dark font-medium">工具集</span>
            </div>

            <!-- Header Actions -->
            <div class="flex items-center space-x-6 text-sm">
                <button class="flex items-center text-text-secondary-light dark:text-text-secondary-dark hover:text-primary transition-colors">
                    <span class="material-icons-outlined mr-1 text-lg">diamond</span>
                    套餐资源
                    <span class="material-icons-outlined text-xs ml-1">expand_more</span>
                </button>
                <button class="flex items-center text-text-secondary-light dark:text-text-secondary-dark hover:text-primary transition-colors">
                    <span class="material-icons-outlined mr-1 text-lg">download</span>
                    客户端(v2.1.0)
                </button>
                <div class="flex items-center cursor-pointer group">
                    <div class="w-8 h-8 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center text-primary font-bold mr-2 border border-blue-200 dark:border-blue-800">
                        <span class="material-icons-outlined text-sm">person</span>
                    </div>
                    <span class="text-text-primary-light dark:text-text-primary-dark group-hover:text-primary transition-colors">陈伟佳Vega</span>
                    <span class="material-icons-outlined text-xs ml-1 text-text-secondary-light">expand_more</span>
                </div>
            </div>
        </header>

        <!-- Content Scroll Area -->
        <div class="flex-1 overflow-auto p-6 scroll-smooth">
            
            <!-- Page Title & Description -->
            <div class="mb-6">
                <div class="flex items-center mb-2">
                    <div class="w-1 h-5 bg-primary mr-3 rounded-full"></div>
                    <h1 class="text-lg font-bold text-text-primary-light dark:text-text-primary-dark">工具集</h1>
                </div>
                <div class="text-sm text-text-secondary-light dark:text-text-secondary-dark leading-relaxed max-w-5xl bg-blue-50/50 dark:bg-blue-900/10 p-3 rounded-md border border-blue-100 dark:border-blue-900/30">
                    【工具集】是探域智能体平台中一项核心的自定义功能，您可以基于我们持续丰富的工具类型为您的 Agent 创建专属技能，使其不再局限于通用问答，而是能精准执行特定任务（如尺码推荐、报价计算等），从而提供更专业的服务。
                </div>
            </div>

            <!-- Filter & Action Bar -->
            <div class="bg-surface-light dark:bg-surface-dark p-4 rounded-lg shadow-sm border border-border-light dark:border-border-dark mb-6">
                
                <!-- Primary Actions -->
                <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
                    <div class="flex items-center space-x-2 w-full md:w-auto">
                        <!-- Tab Switch -->
                        <div class="inline-flex rounded-md shadow-sm" role="group">
                            <button class="px-4 py-2 text-sm font-medium text-primary bg-blue-50 dark:bg-blue-900/30 border border-primary dark:border-blue-700 rounded-l-lg hover:bg-blue-100 dark:hover:bg-blue-800 focus:z-10" type="button">
                                全部工具
                            </button>
                            <button class="px-4 py-2 text-sm font-medium text-text-secondary-light dark:text-text-secondary-dark bg-white dark:bg-surface-dark border-t border-b border-r border-border-light dark:border-border-dark rounded-r-lg hover:bg-gray-50 dark:hover:bg-gray-700 focus:z-10" type="button">
                                按商品查看
                            </button>
                        </div>

                        <!-- Search Box -->
                        <div class="flex-1 md:flex-none flex items-center max-w-md">
                            <div class="relative w-64">
                                <input class="block w-full p-2 text-sm text-text-primary-light dark:text-text-primary-dark border border-border-light dark:border-border-dark rounded-l-md bg-white dark:bg-surface-dark focus:ring-1 focus:ring-primary focus:border-primary outline-none transition-all" placeholder="请输入工具名称" type="text"/>
                            </div>
                            <button class="px-4 py-2 text-sm font-medium text-white bg-primary rounded-r-md border border-primary hover:bg-primary-hover focus:ring-2 focus:ring-blue-300 dark:focus:ring-blue-800 transition-colors">
                                搜索
                            </button>
                        </div>

                        <button class="px-3 py-2 text-sm font-medium text-text-primary-light dark:text-text-primary-dark bg-white dark:bg-surface-dark border border-border-light dark:border-border-dark rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                            重置
                        </button>
                        <button class="flex items-center px-3 py-2 text-sm font-medium text-primary hover:text-primary-hover transition-colors">
                            <span class="material-icons-outlined text-base mr-1">filter_alt</span>
                            更多筛选 (0)
                        </button>
                    </div>

                    <!-- Add Button with ID for JS trigger -->
                    <button onclick="openModal()" class="flex items-center px-4 py-2 text-sm font-medium text-white bg-primary rounded-md hover:bg-primary-hover focus:ring-4 focus:ring-blue-300 dark:focus:ring-blue-800 shadow-sm ml-auto transition-transform active:scale-95">
                        <span class="material-icons-outlined text-base mr-1">add</span>
                        新建工具
                    </button>
                </div>

                <!-- Secondary Filters -->
                <div class="flex flex-wrap items-center gap-4 text-sm border-t border-border-light dark:border-border-dark pt-4">
                    <div class="flex items-center space-x-2">
                        <span class="text-text-secondary-light dark:text-text-secondary-dark">启用状态:</span>
                        <div class="inline-flex rounded-md shadow-sm" role="group">
                            <button class="px-3 py-1.5 text-xs font-medium text-primary border border-primary bg-blue-50 dark:bg-blue-900/30 rounded-l hover:bg-blue-100" type="button">全部</button>
                            <button class="px-3 py-1.5 text-xs font-medium text-text-secondary-light border-t border-b border-r border-border-light hover:bg-gray-50" type="button">开启</button>
                            <button class="px-3 py-1.5 text-xs font-medium text-text-secondary-light border-t border-b border-r border-border-light rounded-r hover:bg-gray-50" type="button">关闭</button>
                        </div>
                    </div>

                    <div class="relative">
                        <select class="appearance-none bg-white dark:bg-surface-dark border border-border-light dark:border-border-dark text-text-primary-light dark:text-text-primary-dark text-sm rounded-md focus:ring-primary focus:border-primary block w-32 px-3 py-1.5 pr-8">
                            <option>全部工具类型</option>
                            <option>尺码推荐</option>
                            <option>物流查询</option>
                            <option>价格计算</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-text-secondary-light">
                            <span class="material-icons-outlined text-sm">expand_more</span>
                        </div>
                    </div>

                    <div class="flex items-center space-x-2 flex-1">
                        <span class="text-text-secondary-light dark:text-text-secondary-dark whitespace-nowrap">可用店铺:</span>
                        <div class="relative w-full max-w-xs">
                            <select class="appearance-none w-full bg-white dark:bg-surface-dark border border-border-light dark:border-border-dark text-text-primary-light dark:text-text-primary-dark text-sm rounded-md focus:ring-primary focus:border-primary block px-3 py-1.5 pr-8 h-8">
                                <option>所有店铺</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-text-secondary-light">
                                <span class="material-icons-outlined text-sm">expand_more</span>
                            </div>
                        </div>
                    </div>

                    <div class="ml-auto flex items-center text-text-secondary-light dark:text-text-secondary-dark cursor-pointer hover:text-primary">
                        <span>更新时间新到旧</span>
                        <span class="material-icons-outlined text-sm ml-1">expand_more</span>
                    </div>
                </div>
            </div>

            <!-- Tool Cards Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 pb-20">
                
                <!-- Card 1 -->
                <div class="bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark rounded-lg p-5 shadow-sm hover:shadow-md hover:border-primary/50 transition-all relative group">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center gap-2">
                             <div class="bg-blue-100 p-1.5 rounded text-primary">
                                <span class="material-icons-outlined text-lg">straighten</span>
                             </div>
                             <h3 class="text-base font-bold text-text-primary-light dark:text-text-primary-dark truncate max-w-[120px]" title="上衣尺码计算">上衣</h3>
                        </div>
                        <!-- Toggle Switch -->
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" value="" class="sr-only peer" checked>
                            <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                        </label>
                    </div>
                    <div class="flex flex-wrap gap-2 mb-4">
                        <span class="px-2 py-0.5 bg-green-50 dark:bg-green-900/30 text-green-700 dark:text-green-400 text-xs rounded border border-green-200 dark:border-green-800/50">
                            服饰尺码计算器
                        </span>
                        <span class="px-2 py-0.5 bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 text-xs rounded border border-blue-200 dark:border-blue-800/50">
                            手动创建
                        </span>
                    </div>
                    <div class="flex items-center justify-between text-xs text-text-secondary-light dark:text-text-secondary-dark mt-6 pt-4 border-t border-dashed border-border-light dark:border-gray-700">
                        <span>2025-10-24 09:38</span>
                        <button class="text-gray-400 hover:text-primary dark:hover:text-primary transition-colors p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-800">
                            <span class="material-icons-outlined text-lg">more_horiz</span>
                        </button>
                    </div>
                </div>

                <!-- Card 2 -->
                <div class="bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark rounded-lg p-5 shadow-sm hover:shadow-md hover:border-primary/50 transition-all relative group">
                    <div class="flex justify-between items-start mb-3">
                         <div class="flex items-center gap-2">
                             <div class="bg-blue-100 p-1.5 rounded text-primary">
                                <span class="material-icons-outlined text-lg">straighten</span>
                             </div>
                             <h3 class="text-base font-bold text-text-primary-light dark:text-text-primary-dark truncate max-w-[120px]" title="牛仔裤通用尺码表">牛仔裤通用...</h3>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" value="" class="sr-only peer" checked>
                            <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                        </label>
                    </div>
                    <div class="flex flex-wrap gap-2 mb-4">
                        <span class="px-2 py-0.5 bg-green-50 dark:bg-green-900/30 text-green-700 dark:text-green-400 text-xs rounded border border-green-200 dark:border-green-800/50">
                            服饰尺码计算器
                        </span>
                        <span class="px-2 py-0.5 bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 text-xs rounded border border-blue-200 dark:border-blue-800/50">
                            手动创建
                        </span>
                    </div>
                    <div class="flex items-center justify-between text-xs text-text-secondary-light dark:text-text-secondary-dark mt-6 pt-4 border-t border-dashed border-border-light dark:border-gray-700">
                        <span>2025-10-23 17:48</span>
                        <button class="text-gray-400 hover:text-primary dark:hover:text-primary transition-colors p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-800">
                            <span class="material-icons-outlined text-lg">more_horiz</span>
                        </button>
                    </div>
                </div>

                <!-- Card 3 -->
                <div class="bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark rounded-lg p-5 shadow-sm hover:shadow-md hover:border-primary/50 transition-all relative group">
                    <div class="flex justify-between items-start mb-3">
                         <div class="flex items-center gap-2">
                             <div class="bg-orange-100 p-1.5 rounded text-orange-600">
                                <span class="material-icons-outlined text-lg">local_shipping</span>
                             </div>
                             <h3 class="text-base font-bold text-text-primary-light dark:text-text-primary-dark truncate max-w-[120px]">顺丰物流查询</h3>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" value="" class="sr-only peer">
                            <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                        </label>
                    </div>
                    <div class="flex flex-wrap gap-2 mb-4">
                        <span class="px-2 py-0.5 bg-orange-50 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400 text-xs rounded border border-orange-200 dark:border-orange-800/50">
                            API集成
                        </span>
                        <span class="px-2 py-0.5 bg-purple-50 dark:bg-purple-900/30 text-purple-700 dark:text-purple-400 text-xs rounded border border-purple-200 dark:border-purple-800/50">
                            系统预设
                        </span>
                    </div>
                    <div class="flex items-center justify-between text-xs text-text-secondary-light dark:text-text-secondary-dark mt-6 pt-4 border-t border-dashed border-border-light dark:border-gray-700">
                        <span>2025-10-22 14:20</span>
                        <button class="text-gray-400 hover:text-primary dark:hover:text-primary transition-colors p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-800">
                            <span class="material-icons-outlined text-lg">more_horiz</span>
                        </button>
                    </div>
                </div>

                 <!-- Card 4 -->
                 <div class="bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark rounded-lg p-5 shadow-sm hover:shadow-md hover:border-primary/50 transition-all relative group">
                    <div class="flex justify-between items-start mb-3">
                         <div class="flex items-center gap-2">
                             <div class="bg-indigo-100 p-1.5 rounded text-indigo-600">
                                <span class="material-icons-outlined text-lg">calculate</span>
                             </div>
                             <h3 class="text-base font-bold text-text-primary-light dark:text-text-primary-dark truncate max-w-[120px]">大促满减计算</h3>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" value="" class="sr-only peer" checked>
                            <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                        </label>
                    </div>
                    <div class="flex flex-wrap gap-2 mb-4">
                        <span class="px-2 py-0.5 bg-green-50 dark:bg-green-900/30 text-green-700 dark:text-green-400 text-xs rounded border border-green-200 dark:border-green-800/50">
                            价格计算器
                        </span>
                    </div>
                    <div class="flex items-center justify-between text-xs text-text-secondary-light dark:text-text-secondary-dark mt-6 pt-4 border-t border-dashed border-border-light dark:border-gray-700">
                        <span>2025-10-20 11:00</span>
                        <button class="text-gray-400 hover:text-primary dark:hover:text-primary transition-colors p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-800">
                            <span class="material-icons-outlined text-lg">more_horiz</span>
                        </button>
                    </div>
                </div>

            </div>
        </div>

        <!-- Floating Quick Actions -->
        <div class="fixed right-6 bottom-20 flex flex-col gap-3 z-30">
            <button class="w-10 h-10 bg-white dark:bg-surface-dark rounded-full shadow-lg flex items-center justify-center text-text-secondary-light dark:text-text-secondary-dark hover:bg-gray-50 dark:hover:bg-gray-700 border border-border-light dark:border-border-dark transition-transform hover:scale-105" title="快捷菜单">
                <span class="material-icons-outlined">grid_view</span>
            </button>
            <button class="w-10 h-10 bg-pink-50 dark:bg-pink-900/50 rounded-full shadow-lg flex items-center justify-center text-pink-500 dark:text-pink-300 hover:bg-pink-100 dark:hover:bg-pink-800/50 border border-pink-200 dark:border-pink-800 transition-transform hover:scale-105" title="问题反馈">
                <span class="material-icons-outlined">bug_report</span>
            </button>
        </div>

        <!-- Floating Main Action (Chat/Agent) -->
        <div class="fixed right-6 bottom-6 flex flex-col gap-3 z-30">
            <button class="w-12 h-12 bg-primary rounded-full shadow-lg flex items-center justify-center text-white hover:bg-primary-hover transition-transform hover:scale-110 shadow-blue-500/30">
                <span class="material-icons-outlined">description</span>
            </button>
            <!-- Chat Agent Button -->
            <button class="w-12 h-12 bg-white dark:bg-surface-dark border border-primary/20 dark:border-primary/40 rounded-full shadow-lg flex items-center justify-center text-primary hover:bg-blue-50 dark:hover:bg-blue-900/30 transition-transform hover:scale-110 overflow-hidden relative">
                 <div class="absolute inset-0 bg-blue-500 opacity-0 hover:opacity-10 transition-opacity"></div>
                <span class="material-icons-outlined text-3xl">smart_toy</span>
                <!-- Online Status Dot -->
                <span class="absolute top-2 right-2 w-2 h-2 bg-green-500 rounded-full border border-white"></span>
            </button>
        </div>

    </main>

    <!-- Modal (New Tool Selection) -->
    <div id="newToolModal" class="fixed inset-0 z-50 hidden flex items-center justify-center" role="dialog" aria-modal="true">
        <!-- Backdrop -->
        <div class="fixed inset-0 bg-black/40 backdrop-blur-[1px] transition-opacity" onclick="closeModal()"></div>
        
        <!-- Modal Content -->
        <div class="relative z-50 w-full max-w-[900px] h-[600px] bg-surface-light dark:bg-surface-dark rounded-lg shadow-modal flex flex-col animate-fade-in-up mx-4 border border-border-light dark:border-border-dark">
            <div class="flex items-center justify-between px-8 py-6 border-b border-border-light dark:border-border-dark">
                <h2 class="text-xl font-bold text-text-primary-light dark:text-text-primary-dark tracking-wide">
                    新建工具
                </h2>
                <button onclick="closeModal()" class="text-text-secondary-light dark:text-text-secondary-dark hover:text-text-primary-light dark:hover:text-text-primary-dark transition-colors focus:outline-none">
                    <span class="material-icons-outlined text-2xl">close</span>
                </button>
            </div>
            
            <div class="flex-1 p-8 overflow-y-auto">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Tool Card 1: Size Calculator -->
                    <div class="group relative flex flex-col justify-between border border-border-light dark:border-border-dark rounded-lg bg-surface-light dark:bg-surface-dark p-6 h-48 hover:shadow-card-hover hover:border-primary transition-all duration-200 cursor-pointer">
                        <div>
                            <h3 class="text-base font-bold text-text-primary-light dark:text-text-primary-dark mb-3">
                                服饰尺码计算器
                            </h3>
                            <p class="text-sm text-text-secondary-light dark:text-text-secondary-dark leading-relaxed line-clamp-3">
                                配置该工具，智能体将自动提取买家信息并根据尺码表计算合适的尺码结果
                            </p>
                        </div>
                        <!-- Button only visible on hover -->
                        <div class="mt-4 opacity-0 group-hover:opacity-100 transition-opacity duration-200 absolute bottom-6 left-6 right-6">
                            <button class="bg-primary hover:bg-primary-hover text-white text-sm font-medium py-1.5 px-6 rounded shadow-sm transition-colors w-fit mx-auto block">
                                创 建
                            </button>
                        </div>
                    </div>

                    <!-- Tool Card 2: Custom Quote Calculator (NEW) -->
                    <div class="group relative flex flex-col justify-between border border-border-light dark:border-border-dark rounded-lg bg-surface-light dark:bg-surface-dark p-6 h-48 hover:shadow-card-hover hover:border-primary transition-all duration-200 cursor-pointer">
                        <div>
                            <h3 class="text-base font-bold text-text-primary-light dark:text-text-primary-dark mb-3">
                                定制报价计算器
                            </h3>
                            <p class="text-sm text-text-secondary-light dark:text-text-secondary-dark leading-relaxed line-clamp-3">
                                支持配置复杂的计价公式，Agent 可自动提取买家需求参数并输出精准报价。
                            </p>
                        </div>
                        <!-- Buttons only visible on hover -->
                        <div class="mt-4 opacity-0 group-hover:opacity-100 transition-opacity duration-200 absolute bottom-6 left-6 right-6 flex gap-3">
                            <!-- onclick triggers the drawer -->
                            <button onclick="openQuoteDrawer()" class="flex-1 bg-primary hover:bg-primary-hover text-white text-sm font-medium py-1.5 rounded shadow-sm transition-colors text-center whitespace-nowrap">
                                新建空白
                            </button>
                            <button class="flex-1 bg-white dark:bg-surface-dark border border-primary text-primary hover:bg-blue-50 dark:hover:bg-blue-900/30 text-sm font-medium py-1.5 rounded shadow-sm transition-colors text-center whitespace-nowrap">
                                使用模版
                            </button>
                        </div>
                    </div>

                    <!-- Placeholder Card -->
                    <div class="flex flex-col border border-border-light dark:border-border-dark rounded-lg bg-gray-50 dark:bg-gray-800/50 p-6 h-48 border-dashed">
                        <h3 class="text-base font-bold text-text-primary-light dark:text-text-primary-dark mb-3">
                            更多工具
                        </h3>
                        <div class="flex-1 flex items-end">
                            <p class="text-sm text-text-secondary-light dark:text-text-secondary-dark leading-relaxed">
                                更多工具陆续更新中......
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Input Parameter Modal (Highest Z-Index) -->
    <div id="addParamModal" class="fixed inset-0 z-[80] hidden flex items-center justify-center" role="dialog" aria-modal="true">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm transition-opacity" onclick="closeParamModal()"></div>
        <!-- Modal Panel -->
        <div class="relative w-full max-w-2xl bg-surface-light dark:bg-surface-dark rounded-lg shadow-2xl p-6 transform transition-all border border-border-light dark:border-border-dark animate-fade-in-up">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-lg font-bold text-text-primary-light dark:text-text-primary-dark">自定义参数</h2>
                <button onclick="closeParamModal()" class="text-text-secondary-light dark:text-text-secondary-dark hover:text-text-primary-light dark:hover:text-text-primary-dark transition-colors">
                    <span class="material-icons-outlined">close</span>
                </button>
            </div>
            
            <div class="space-y-6">
                <div class="grid grid-cols-12 gap-6">
                    <!-- Param Name -->
                    <div class="col-span-5">
                        <label class="block text-sm font-medium text-text-primary-light dark:text-text-primary-dark mb-2">
                            <span class="text-red-500 mr-1">*</span>参数名
                            <span class="material-icons-outlined text-sm text-text-secondary-light dark:text-text-secondary-dark ml-1 align-text-bottom cursor-help" title="参数的唯一标识符">help_outline</span>
                        </label>
                        <input id="modalParamName" class="w-full h-10 px-3 bg-white dark:bg-gray-700 border border-border-light dark:border-border-dark rounded text-sm focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none placeholder-gray-400 text-text-primary-light dark:text-text-primary-dark" placeholder="输入参数名称" type="text"/>
                    </div>
                    <!-- Type -->
                    <div class="col-span-3">
                        <label class="block text-sm font-medium text-text-primary-light dark:text-text-primary-dark mb-2">
                            <span class="text-red-500 mr-1">*</span>类型
                            <span class="material-icons-outlined text-sm text-text-secondary-light dark:text-text-secondary-dark ml-1 align-text-bottom cursor-help" title="参数的数据类型">help_outline</span>
                        </label>
                        <div class="relative">
                            <select id="modalParamType" class="w-full h-10 px-3 bg-white dark:bg-gray-700 border border-border-light dark:border-border-dark rounded text-sm appearance-none focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none pr-8 text-text-primary-light dark:text-text-primary-dark">
                                <option>数字</option>
                                <option>文本</option>
                            </select>
                            <span class="material-icons-outlined absolute right-2 top-2.5 text-base text-text-secondary-light dark:text-text-secondary-dark pointer-events-none">expand_more</span>
                        </div>
                    </div>
                    <!-- Unit -->
                    <div class="col-span-4">
                        <label class="block text-sm font-medium text-text-primary-light dark:text-text-primary-dark mb-2">
                            <span class="text-red-500 mr-1">*</span>单位
                        </label>
                        <input id="modalParamUnit" class="w-full h-10 px-3 bg-white dark:bg-gray-700 border border-border-light dark:border-border-dark rounded text-sm focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none placeholder-gray-400 text-text-primary-light dark:text-text-primary-dark" placeholder="输入单位" type="text"/>
                    </div>
                </div>
                
                <!-- Description -->
                <div>
                    <label class="block text-sm font-medium text-text-primary-light dark:text-text-primary-dark mb-2">
                        参数描述
                        <span class="material-icons-outlined text-sm text-text-secondary-light dark:text-text-secondary-dark ml-1 align-text-bottom cursor-help" title="详细描述参数用途">help_outline</span>
                    </label>
                    <textarea id="modalParamDesc" class="w-full h-24 px-3 py-2 bg-white dark:bg-gray-700 border border-border-light dark:border-border-dark rounded text-sm focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none resize-none placeholder-gray-400 text-text-primary-light dark:text-text-primary-dark" placeholder="请描述参数的具体内容，指引智能客服更好地获取买家相关信息"></textarea>
                </div>
            </div>

            <div class="flex justify-end gap-3 mt-8 pt-4">
                <button onclick="closeParamModal()" class="px-6 py-2 border border-border-light dark:border-border-dark rounded text-sm text-text-primary-light dark:text-text-primary-dark hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
                    取消
                </button>
                <button onclick="confirmAddParam()" class="px-6 py-2 bg-primary text-white rounded text-sm font-medium hover:bg-primary-hover transition-colors shadow-sm">
                    确定
                </button>
            </div>
        </div>
    </div>

    <!-- Quote Calculator Drawer -->
    <!-- Backdrop -->
    <div id="quoteDrawerBackdrop" class="fixed inset-0 bg-black/30 z-[60] backdrop-blur-sm hidden transition-opacity" onclick="closeQuoteDrawer()"></div>
    
    <!-- Drawer Container -->
    <div id="quoteDrawer" class="fixed inset-y-0 right-0 w-full max-w-[90%] md:max-w-[1200px] bg-surface-light dark:bg-surface-dark shadow-2xl z-[70] transform transition-transform duration-300 translate-x-full flex flex-col h-full border-l border-border-light dark:border-border-dark">
        <!-- Drawer Header -->
        <div class="h-14 px-6 border-b border-border-light dark:border-border-dark flex items-center justify-between flex-shrink-0 bg-surface-light dark:bg-surface-dark">
            <div class="flex items-center gap-3">
                <button onclick="closeQuoteDrawer()" class="text-text-secondary-light dark:text-text-secondary-dark hover:text-text-primary-light dark:hover:text-text-primary-dark transition-colors p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-800">
                    <span class="material-icons-outlined text-xl">close</span>
                </button>
                <h2 class="text-base font-bold text-text-primary-light dark:text-text-primary-dark">新建定制报价</h2>
            </div>
        </div>

        <!-- Drawer Content (Two Columns) -->
        <div class="flex-1 overflow-hidden flex flex-col md:flex-row">
            <!-- Left Column: Main Configuration -->
            <div class="flex-1 overflow-y-auto p-6 space-y-8 border-r border-border-light dark:border-border-dark scroll-smooth bg-surface-light dark:bg-surface-dark">
                <!-- Tool Name -->
                <section>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-text-secondary-light dark:text-text-secondary-dark mb-1">工具名称</label>
                        <div class="relative">
                            <input class="w-full h-10 px-3 py-2 bg-white dark:bg-gray-800 border border-border-light dark:border-border-dark rounded focus:outline-none focus:ring-2 focus:ring-primary/50 text-sm text-text-primary-light dark:text-text-primary-dark placeholder-gray-400" placeholder="请输入工具名称" type="text"/>
                            <span class="absolute right-3 top-2.5 text-xs text-text-secondary-light dark:text-text-secondary-dark">0 / 50</span>
                        </div>
                    </div>
                </section>

                <!-- Input Parameters -->
                <section>
                    <div class="flex items-center gap-2 mb-4">
                        <div class="w-1 h-4 bg-primary rounded-full"></div>
                        <h3 class="text-sm font-bold text-text-primary-light dark:text-text-primary-dark">参数配置</h3>
                    </div>
                    <!-- Container for Input Parameter Rows -->
                    <div id="inputParamsList">
                        <!-- Initial Row -->
                        <div class="border border-border-light dark:border-border-dark rounded-lg p-4 mb-3 bg-white dark:bg-gray-800 shadow-sm relative group">
                            <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                                <div class="md:col-span-4">
                                    <label class="block text-xs text-text-secondary-light dark:text-text-secondary-dark mb-1"><span class="text-red-500">*</span> 参数名</label>
                                    <input class="w-full h-9 px-3 bg-white dark:bg-gray-700 border border-border-light dark:border-border-dark rounded text-sm focus:border-primary focus:ring-1 focus:ring-primary outline-none text-text-primary-light dark:text-text-primary-dark" type="text" value="长" readonly/>
                                </div>
                                <div class="md:col-span-3">
                                    <label class="block text-xs text-text-secondary-light dark:text-text-secondary-dark mb-1"><span class="text-red-500">*</span> 类型</label>
                                    <input class="w-full h-9 px-3 bg-white dark:bg-gray-700 border border-border-light dark:border-border-dark rounded text-sm focus:border-primary focus:ring-1 focus:ring-primary outline-none text-text-primary-light dark:text-text-primary-dark" type="text" value="数字" readonly/>
                                </div>
                                <div class="md:col-span-3">
                                    <label class="block text-xs text-text-secondary-light dark:text-text-secondary-dark mb-1"><span class="text-red-500">*</span> 单位</label>
                                    <input class="w-full h-9 px-3 bg-white dark:bg-gray-700 border border-border-light dark:border-border-dark rounded text-sm focus:border-primary focus:ring-1 focus:ring-primary outline-none text-text-primary-light dark:text-text-primary-dark" type="text" value="米" readonly/>
                                </div>
                                <div class="md:col-span-2 flex justify-end items-center h-9 gap-2">
                                    <button class="p-1 text-text-secondary-light dark:text-text-secondary-dark hover:text-primary transition-colors">
                                        <span class="material-icons-outlined text-lg">edit</span>
                                    </button>
                                    <button class="p-1 text-text-secondary-light dark:text-text-secondary-dark hover:text-red-500 transition-colors" onclick="this.closest('.group').remove()">
                                        <span class="material-icons-outlined text-lg">delete</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="openParamModal()" class="w-32 h-9 flex items-center justify-center gap-1 border border-border-light dark:border-border-dark rounded text-sm text-text-primary-light dark:text-text-primary-dark hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
                        <span class="material-icons-outlined text-sm">add</span>
                        新增参数
                    </button>
                </section>

                <!-- Pricing Table / Data Source -->
                <section>
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <div class="w-1 h-4 bg-primary rounded-full"></div>
                            <h3 class="text-sm font-bold text-text-primary-light dark:text-text-primary-dark">价格表/基础数据</h3>
                        </div>
                    </div>
                    <!-- Select Dropdown Replacement -->
                    <label class="block text-sm font-medium text-text-secondary-light dark:text-text-secondary-dark mb-2">选择表格</label>
                    <div class="relative">
                        <select class="w-full h-10 px-3 bg-white dark:bg-gray-800 border border-border-light dark:border-border-dark rounded focus:outline-none focus:ring-2 focus:ring-primary/50 text-sm text-text-primary-light dark:text-text-primary-dark appearance-none pr-8">
                            <option value="">请选择数据源表格...</option>
                            <option value="1">2025春季面料价格表</option>
                            <option value="2">通用辅料价格表</option>
                        </select>
                        <span class="material-icons-outlined absolute right-2 top-2.5 text-base text-text-secondary-light dark:text-text-secondary-dark pointer-events-none">expand_more</span>
                    </div>
                </section>

                <!-- Calculation Logic -->
                <section>
                    <div class="flex items-center gap-2 mb-4">
                        <div class="w-1 h-4 bg-primary rounded-full"></div>
                        <h3 class="text-sm font-bold text-text-primary-light dark:text-text-primary-dark">计算逻辑</h3>
                    </div>
                    <div class="relative w-full">
                        <textarea id="calcLogicTextarea" 
                            oninput="autoResizeTextarea(this); handleMentionTrigger(this)" 
                            class="w-full min-h-[128px] px-3 py-2 bg-white dark:bg-gray-800 border border-border-light dark:border-border-dark rounded focus:outline-none focus:ring-2 focus:ring-primary/50 text-sm resize-none placeholder-gray-400 text-text-primary-light dark:text-text-primary-dark font-mono overflow-hidden" 
                            placeholder="请在此清晰描述计算需求，推荐输入公式进行描述。描述的过程中需要引用上述参数或表格时，可以使用”@”"></textarea>
                        <span class="absolute right-3 bottom-2 text-xs text-text-secondary-light dark:text-text-secondary-dark pointer-events-none">0 / 2000</span>
                        
                        <!-- Dropdown Menu (Hidden initially) -->
                        <div id="mentionDropdown" class="hidden absolute left-0 z-50 w-56 bg-white dark:bg-gray-800 rounded-md shadow-dropdown border border-border-light dark:border-border-dark overflow-hidden animate-fade-in-up">
                            <div class="py-1" id="mentionDropdownList">
                                <!-- Dynamic items will be injected here -->
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Right Column: Settings & Properties -->
            <div class="w-full md:w-80 bg-gray-50 dark:bg-gray-900/50 overflow-y-auto p-6 space-y-6 flex-shrink-0 border-l border-border-light dark:border-border-dark">
                <!-- Basic Properties -->
                <div>
                    <div class="flex items-center gap-2 mb-3">
                        <div class="w-1 h-4 bg-primary rounded-full"></div>
                        <h3 class="text-sm font-bold text-text-primary-light dark:text-text-primary-dark">基本属性</h3>
                    </div>
                    <div class="space-y-4 text-sm">
                        <div class="flex items-start">
                            <span class="w-20 text-text-secondary-light dark:text-text-secondary-dark shrink-0">工具类型：</span>
                            <span class="bg-indigo-100 dark:bg-indigo-900/40 text-indigo-700 dark:text-indigo-400 px-2 py-0.5 rounded text-xs border border-indigo-200 dark:border-indigo-800">定制报价计算器</span>
                        </div>
                        <div class="flex items-start">
                            <span class="w-20 text-text-secondary-light dark:text-text-secondary-dark shrink-0">工具来源：</span>
                            <span class="bg-blue-100 dark:bg-blue-900/40 text-blue-700 dark:text-blue-400 px-2 py-0.5 rounded text-xs border border-blue-200 dark:border-blue-800">手动创建</span>
                        </div>
                    </div>
                </div>

                <!-- Matching Conditions -->
                <div>
                    <div class="flex items-center gap-2 mb-3">
                        <div class="w-1 h-4 bg-primary rounded-full"></div>
                        <div class="flex items-center gap-1">
                            <h3 class="text-sm font-bold text-text-primary-light dark:text-text-primary-dark">匹配条件</h3>
                            <span class="material-icons-outlined text-xs text-text-secondary-light dark:text-text-secondary-dark cursor-help">help_outline</span>
                        </div>
                    </div>
                    <div class="flex rounded-md shadow-sm mb-3">
                        <button class="flex-1 px-4 py-1.5 text-sm font-medium border border-border-light dark:border-border-dark rounded-l-md bg-white dark:bg-gray-800 text-text-primary-light dark:text-text-primary-dark hover:bg-gray-50 dark:hover:bg-gray-700 z-10 relative focus:z-20 border-r-0 ring-1 ring-inset ring-transparent focus:ring-primary">包含条件</button>
                        <button class="flex-1 px-4 py-1.5 text-sm font-medium border border-border-light dark:border-border-dark rounded-r-md bg-gray-100 dark:bg-gray-900 text-text-secondary-light dark:text-text-secondary-dark hover:bg-white dark:hover:bg-gray-800 focus:z-20">排除条件</button>
                    </div>
                    <div class="space-y-2">
                        <div class="bg-white dark:bg-gray-800 border border-border-light dark:border-border-dark rounded px-3 py-2.5 flex justify-between items-center cursor-pointer hover:border-primary transition-colors group">
                            <span class="text-sm text-text-primary-light dark:text-text-primary-dark">指定商品</span>
                            <span class="material-icons-outlined text-primary text-lg opacity-0 group-hover:opacity-100 transition-opacity">add_circle_outline</span>
                        </div>
                        <div class="bg-white dark:bg-gray-800 border border-border-light dark:border-border-dark rounded px-3 py-2.5 flex justify-between items-center cursor-pointer hover:border-primary transition-colors group">
                            <span class="text-sm text-text-primary-light dark:text-text-primary-dark">指定商品分组</span>
                            <span class="material-icons-outlined text-primary text-lg opacity-0 group-hover:opacity-100 transition-opacity">add_circle_outline</span>
                        </div>
                        <div class="bg-white dark:bg-gray-800 border border-border-light dark:border-border-dark rounded px-3 py-2.5 flex justify-between items-center cursor-pointer hover:border-primary transition-colors group">
                            <span class="text-sm text-text-primary-light dark:text-text-primary-dark">指定店铺</span>
                            <span class="material-icons-outlined text-primary text-lg opacity-0 group-hover:opacity-100 transition-opacity">add_circle_outline</span>
                        </div>
                    </div>
                </div>

                <!-- Restrictions -->
                <div>
                    <div class="flex items-center gap-2 mb-3">
                        <div class="w-1 h-4 bg-primary rounded-full"></div>
                        <h3 class="text-sm font-bold text-text-primary-light dark:text-text-primary-dark">限制条件</h3>
                    </div>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-text-primary-light dark:text-text-primary-dark">时效限制：</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" value="" class="sr-only peer">
                                <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                            </label>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-text-primary-light dark:text-text-primary-dark">订单状态限制：</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" value="" class="sr-only peer">
                                <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Drawer Footer -->
        <div class="h-16 border-t border-border-light dark:border-border-dark px-6 flex items-center justify-end gap-3 bg-surface-light dark:bg-surface-dark flex-shrink-0">
            <button onclick="closeQuoteDrawer()" class="px-4 py-2 border border-border-light dark:border-border-dark rounded text-sm text-text-primary-light dark:text-text-primary-dark hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
                取消
            </button>
            <button onclick="openSaveConfirmModal()" class="px-4 py-2 border border-border-light dark:border-border-dark rounded text-sm text-text-primary-light dark:text-text-primary-dark hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
                保存不启用
            </button>
            <button onclick="openSaveConfirmModal()" class="px-4 py-2 bg-primary text-white rounded text-sm font-medium hover:bg-primary-hover transition-colors shadow-sm">
                保存并启用
            </button>
        </div>
    </div>

    <!-- Confirm Save Modal -->
    <div id="saveConfirmModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-black/40 backdrop-blur-[1px] transition-opacity" onclick="closeSaveConfirmModal()"></div>
        <div class="relative w-full max-w-md bg-surface-light dark:bg-surface-dark rounded-lg shadow-2xl p-6 transform transition-all border border-border-light dark:border-border-dark animate-fade-in-up">
            <div class="flex gap-4">
                <div class="flex-shrink-0 w-10 h-10 rounded-full bg-yellow-100 dark:bg-yellow-900/30 flex items-center justify-center text-yellow-600 dark:text-yellow-500">
                    <span class="material-icons-outlined text-xl">warning_amber</span>
                </div>
                <div>
                    <h3 class="text-lg font-bold text-text-primary-light dark:text-text-primary-dark mb-2">确认更新计算配置？</h3>
                    <p class="text-sm text-text-secondary-light dark:text-text-secondary-dark leading-relaxed">
                        检测到您修改了计算参数或逻辑。保存后，系统将重新编译智能计算模型，原有逻辑将被覆盖。此过程不可逆，是否继续？
                    </p>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeSaveConfirmModal()" class="px-4 py-2 border border-border-light dark:border-border-dark rounded text-sm text-text-primary-light dark:text-text-primary-dark hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
                    再想想
                </button>
                <button onclick="proceedToSave()" class="px-4 py-2 bg-primary text-white rounded text-sm font-medium hover:bg-primary-hover transition-colors shadow-sm">
                    确认更新
                </button>
            </div>
        </div>
    </div>

    <!-- Generating Process Modal -->
    <div id="generatingLoadingModal" class="fixed inset-0 z-[110] hidden flex items-center justify-center" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-black/50 backdrop-blur-sm transition-opacity"></div>
        <div class="relative w-full max-w-sm bg-surface-light dark:bg-surface-dark rounded-lg shadow-2xl p-8 transform transition-all border border-border-light dark:border-border-dark animate-fade-in-up flex flex-col items-center justify-center">
            
            <div class="spinner spinner-blue mb-4"></div>
            
            <h3 class="text-lg font-bold text-text-primary-light dark:text-text-primary-dark mb-2">正在生成计算过程</h3>
            <p class="text-sm text-text-secondary-light dark:text-text-secondary-dark text-center leading-relaxed">
                智能计算引擎正在解析并生成执行代码<br/>预计需要 30 秒，请耐心等待...
            </p>
        </div>
    </div>

    <script>
        // Simple Dark Mode Toggle Logic
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
        }
        
        // Modal Logic
        function openModal() {
            const modal = document.getElementById('newToolModal');
            modal.classList.remove('hidden');
        }

        function closeModal() {
            const modal = document.getElementById('newToolModal');
            modal.classList.add('hidden');
        }

        // Quote Drawer Logic
        function openQuoteDrawer() {
            // First close the modal selection
            closeModal();
            
            const drawer = document.getElementById('quoteDrawer');
            const backdrop = document.getElementById('quoteDrawerBackdrop');
            
            // Show backdrop
            backdrop.classList.remove('hidden');
            
            // Slide in drawer (small delay to ensure transition happens)
            setTimeout(() => {
                drawer.classList.remove('translate-x-full');
            }, 10);
        }

        function closeQuoteDrawer() {
            const drawer = document.getElementById('quoteDrawer');
            const backdrop = document.getElementById('quoteDrawerBackdrop');
            
            // Slide out drawer
            drawer.classList.add('translate-x-full');
            
            // Hide backdrop after animation matches duration-300
            setTimeout(() => {
                backdrop.classList.add('hidden');
            }, 300);
        }

        // Save Confirm Logic
        function openSaveConfirmModal() {
            const modal = document.getElementById('saveConfirmModal');
            modal.classList.remove('hidden');
        }

        function closeSaveConfirmModal() {
            const modal = document.getElementById('saveConfirmModal');
            modal.classList.add('hidden');
        }

        function proceedToSave() {
            closeSaveConfirmModal();
            const loadingModal = document.getElementById('generatingLoadingModal');
            loadingModal.classList.remove('hidden');

            // Mock waiting time
            setTimeout(() => {
                loadingModal.classList.add('hidden');
                closeQuoteDrawer();
                alert("保存成功！智能计算模型已更新。");
            }, 3000); // 3 seconds demo
        }

        // Add Parameter Modal Logic
        function openParamModal() {
            // Clear inputs
            document.getElementById('modalParamName').value = '';
            document.getElementById('modalParamUnit').value = '';
            document.getElementById('modalParamDesc').value = '';
            
            const modal = document.getElementById('addParamModal');
            modal.classList.remove('hidden');
        }

        function closeParamModal() {
            const modal = document.getElementById('addParamModal');
            modal.classList.add('hidden');
        }

        function confirmAddParam() {
            // Get values
            const name = document.getElementById('modalParamName').value;
            const type = document.getElementById('modalParamType').value;
            const unit = document.getElementById('modalParamUnit').value;

            if (!name || !unit) {
                alert('请填写必要信息');
                return;
            }

            // Add row
            const container = document.getElementById('inputParamsList');
            const newRow = document.createElement('div');
            newRow.className = "border border-border-light dark:border-border-dark rounded-lg p-4 mb-3 bg-white dark:bg-gray-800 shadow-sm relative group";
            newRow.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                    <div class="md:col-span-4">
                        <label class="block text-xs text-text-secondary-light dark:text-text-secondary-dark mb-1"><span class="text-red-500">*</span> 参数名</label>
                        <input class="w-full h-9 px-3 bg-white dark:bg-gray-700 border border-border-light dark:border-border-dark rounded text-sm focus:border-primary focus:ring-1 focus:ring-primary outline-none text-text-primary-light dark:text-text-primary-dark" type="text" value="${name}" readonly/>
                    </div>
                    <div class="md:col-span-3">
                        <label class="block text-xs text-text-secondary-light dark:text-text-secondary-dark mb-1"><span class="text-red-500">*</span> 类型</label>
                        <input class="w-full h-9 px-3 bg-white dark:bg-gray-700 border border-border-light dark:border-border-dark rounded text-sm focus:border-primary focus:ring-1 focus:ring-primary outline-none text-text-primary-light dark:text-text-primary-dark" type="text" value="${type}" readonly/>
                    </div>
                    <div class="md:col-span-3">
                        <label class="block text-xs text-text-secondary-light dark:text-text-secondary-dark mb-1"><span class="text-red-500">*</span> 单位</label>
                        <input class="w-full h-9 px-3 bg-white dark:bg-gray-700 border border-border-light dark:border-border-dark rounded text-sm focus:border-primary focus:ring-1 focus:ring-primary outline-none text-text-primary-light dark:text-text-primary-dark" type="text" value="${unit}" readonly/>
                    </div>
                    <div class="md:col-span-2 flex justify-end items-center h-9 gap-2">
                        <button class="p-1 text-text-secondary-light dark:text-text-secondary-dark hover:text-primary transition-colors">
                            <span class="material-icons-outlined text-lg">edit</span>
                        </button>
                        <button class="p-1 text-text-secondary-light dark:text-text-secondary-dark hover:text-red-500 transition-colors" onclick="this.closest('.group').remove()">
                            <span class="material-icons-outlined text-lg">delete</span>
                        </button>
                    </div>
                </div>
            `;
            container.appendChild(newRow);
            
            closeParamModal();
        }

        // Add Output Parameter Modal Logic
        function openOutputParamModal() {
            // Clear inputs
            document.getElementById('modalOutputParamName').value = '';
            document.getElementById('modalOutputParamDesc').value = '';
            
            const modal = document.getElementById('addOutputParamModal');
            modal.classList.remove('hidden');
        }

        function closeOutputParamModal() {
            const modal = document.getElementById('addOutputParamModal');
            modal.classList.add('hidden');
        }

        // Add subtle interaction to cards
        document.querySelectorAll('.group').forEach(card => {
            card.addEventListener('mouseenter', () => {
                // Could add specific hover logic here if needed beyond CSS
            });
        });

        // --- New Logic for Textarea Auto-resize and Mention Trigger ---

        function autoResizeTextarea(element) {
            element.style.height = 'auto';
            element.style.height = (element.scrollHeight) + 'px';
        }

        function handleMentionTrigger(element) {
            const cursorPosition = element.selectionStart;
            const text = element.value;
            const lastChar = text.substring(cursorPosition - 1, cursorPosition);
            const dropdown = document.getElementById('mentionDropdown');

            if (lastChar === '@') {
                // Trigger dropdown
                showMentionDropdown(element);
            } else {
                // Simple hide logic: if user types space or deletes @
                // Ideally, we'd track if we are currently "in" a mention state
                // For this demo, clicking outside or typing space hides it.
                // We'll hide it on any other input for simplicity unless we are filtering.
                // Let's keep it simple: Show only immediately after typing @
                // dropdown.classList.add('hidden');
            }
        }

        function showMentionDropdown(textarea) {
            const dropdown = document.getElementById('mentionDropdown');
            const list = document.getElementById('mentionDropdownList');
            list.innerHTML = ''; // Clear previous

            // 1. Collect Data
            const data = collectMentionData();

            if (data.length === 0) {
                 const emptyItem = document.createElement('div');
                 emptyItem.className = "px-4 py-2 text-xs text-text-secondary-light dark:text-text-secondary-dark";
                 emptyItem.innerText = "无可用字段";
                 list.appendChild(emptyItem);
            } else {
                data.forEach(item => {
                    const el = document.createElement('div');
                    el.className = "px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer flex justify-between items-center group";
                    el.onclick = () => insertMention(item.name);
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.className = "text-sm text-text-primary-light dark:text-text-primary-dark font-medium";
                    nameSpan.innerText = item.name;

                    const sourceSpan = document.createElement('span');
                    sourceSpan.className = "text-xs text-text-secondary-light dark:text-text-secondary-dark bg-gray-50 dark:bg-gray-600 px-1.5 py-0.5 rounded";
                    sourceSpan.innerText = item.source;

                    el.appendChild(nameSpan);
                    el.appendChild(sourceSpan);
                    list.appendChild(el);
                });
            }

            // 2. Position Dropdown (Simplified relative positioning)
            // In a real app, we'd calculate exact caret coordinates. 
            // Here we'll position it nicely within the container.
            dropdown.style.top = '40px'; // Approx below first line
            dropdown.style.left = '10px';
            dropdown.classList.remove('hidden');
            
            // Auto hide on click outside is handled generally, but let's add a specific listener
            document.addEventListener('click', function hide(e) {
                if (!dropdown.contains(e.target) && e.target !== textarea) {
                    dropdown.classList.add('hidden');
                    document.removeEventListener('click', hide);
                }
            });
        }

        function collectMentionData() {
            const items = [];
            
            // Input Params
            document.querySelectorAll('#inputParamsList input[readonly]').forEach((input, index) => {
                // Every 3rd input is a name in the current grid structure (name, type, unit)
                // But better to select by logic. Our grid structure is consistent.
                // The structure is: paramName (readonly), type (readonly), unit (readonly)
                // Let's rely on the value not being empty and being in the first col div
                if (input.closest('.md\\:col-span-4')) {
                      items.push({ name: input.value, source: '来自参数' });
                }
            });

            // Price Table Fields (Parsed Headers)
            // Removed as requested to only show params

            return items;
        }

        function insertMention(text) {
            const textarea = document.getElementById('calcLogicTextarea');
            const cursorPosition = textarea.selectionStart;
            const currentValue = textarea.value;

            // Remove the '@' that triggered it if we want to replace it, 
            // OR just append. Usually we want "ParamName" after "@".
            // Let's assume we keep the @ and just add the name.
            // Or better: replace the trigger behavior is usually "User types @, list shows, user selects 'Name', result is '@Name ' "
            
            const before = currentValue.substring(0, cursorPosition);
            const after = currentValue.substring(cursorPosition);
            
            // Check if we need to insert a space?
            const newValue = before + text + " " + after;
            
            textarea.value = newValue;
            textarea.focus();
            
            // Move cursor
            const newCursorPos = cursorPosition + text.length + 1;
            textarea.setSelectionRange(newCursorPos, newCursorPos);

            document.getElementById('mentionDropdown').classList.add('hidden');
        }

    </script>
</body>
</html>